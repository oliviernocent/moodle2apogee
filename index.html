<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="author" content="Olivier Nocent">
  <meta name="keywords" content="Moodle, Apogée">
  <meta name="description" content="Outil de conversion de fichiers de notes">
  <title>Moodle2Apogée</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <script src="https://kit.fontawesome.com/e97537c6a1.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.3/xlsx.full.min.js"></script>
</head>

<body>
  <section class="hero is-link mb-5">
    <div class="container">
      <div class="hero-body">
        <p class="title">Moodle2Apogée</p>
        <p class="subtitle">Outil de conversion de fichiers de notes</p>
      </div>
    </div>
  </section>

  <div class="container">
    <section class="section box">
      <h2 class="title">Étape 1</h2>
      <h3 class="subtitle">Récupération du fichier de notes sur Moodle</h3>

      <div class="content">
        <ul>
          <li>Connectez-vous à la plateforme <a href="https://examens.univ-reims.fr" target="_blank">Moodle Examens</a>
          </li>
          <li>Sélectionnez l'épreuve pour laquelle vous voulez exporter les notes</li>
          <li>Exportez le fichier de notes au format Excel</li>
        </ul>
      </div>

      <article class="message is-warning">
        <div class="message-header">
          <p>Attention</p>
        </div>
        <div class="message-body">
          Vérifiez que votre fichier Excel contienne deux colonnes nommées <code>Numéro d’identification</code> et <code>Note/20,00</code>.
        </div>
      </article>


      <div class="file is-boxed">
        <label class="file-label">
          <input id="moodleInput" class="file-input" type="file" name="resume">
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">Déposez votre fichier</span>
          </span>
        </label>
      </div>

      <div id="moodleAlert" class="notification is-danger is-hidden">
        Format de fichier invalide.
      </div>
    </section>

    <section class="section box">
      <h2 class="title">Étape 2</h2>
      <h3 class="subtitle">Récupération du fichier de notes vierge sur Apogée</h3>

      <div class="content">
        <ul>
          <li>Connectez-vous à l'application de <a href="https://frt.univ-reims.fr/snw-web/" target="_blank">Saisie de
              Notes en Ligne</a></li>
          <li>Sélectionnez l'épreuve pour laquelle vous voulez saisir des notes</li>
          <li>Exportez le fichier de notes vierge au format CSV</li>
        </ul>
      </div>

      <div class="file is-boxed">
        <label class="file-label">
          <input id="apogeeInput" class="file-input" type="file" name="resume">
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">Déposez votre fichier</span>
          </span>
        </label>
      </div>
    </section>

    <section class="section box">
      <h2 class="title">Étape 3</h2>
      <h3 class="subtitle">Génération du fichier de notes</h3>

      <div class="content">
        <ul>
          <li>Cliquez sur le bouton <strong>Générer</strong></a>
          </li>
          <li>Téléchargez le fichier résultat sur votre ordinateur</li>
          <li>Importez le fichier dans l'application de <a href="https://frt.univ-reims.fr/snw-web/"
              target="_blank">Saisie de
              Notes
              en Ligne</a></li>
        </ul>
      </div>

      <button id="process" class="button is-responsive is-link">Générer</button>
    </section>

  </div>

  <footer class="footer mt-5">
    <div class="content has-text-centered">
      <p>
        <a href="https://cv.hal.science/oliviernocent" target="_blank">Olivier Nocent</a> &copy; 2025
        <a href="https://github.com/oliviernocent/moodle2apogee" target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </p>
    </div>
  </footer>

  <script>
    let moodleData, apogeeData;
    let apogeeOutputFilename;

    function displayUploadSucceeded(buttonId) {
      document.querySelector(`#${buttonId} + span > span`).classList.add("has-text-success");
      document.querySelector(`#${buttonId} + span > span i`).classList.remove("fa-upload");
      document.querySelector(`#${buttonId} + span > span i`).classList.add("fa-check-square");
      document.querySelector(`#${buttonId} + span .file-label`).textContent = "Fichier déposé";
      moodleAlert.classList.add("is-hidden");
    }

    function resetUploadDisplay(buttonId) {
      document.querySelector(`#${buttonId} + span > span`).classList.remove("has-text-success");
      document.querySelector(`#${buttonId} + span > span i`).classList.remove("fa-check-square");
      document.querySelector(`#${buttonId} + span > span i`).classList.add("fa-upload");
      document.querySelector(`#${buttonId} + span .file-label`).textContent = "Déposez votre fichier";
      moodleAlert.classList.add("is-hidden");
    }

    moodleInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        // Get the binary data
        const data = e.target.result;

        try {
          // Convert the data to a workbook
          const workbook = XLSX.read(data, { type: "binary" });

          // Get the first sheet
          const sheet = workbook.Sheets[workbook.SheetNames[0]];

          // Convert the sheet to JSON
          moodleData = XLSX.utils.sheet_to_json(sheet);

          displayUploadSucceeded("moodleInput");
        }
        catch (error) {
          moodleAlert.classList.remove("is-hidden");
        }
      };

      // Read the data as binary
      reader.readAsBinaryString(file);
    });

    apogeeInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      apogeeOutputFilename = file.name.replace(".csv", "_complet.csv");

      const reader = new FileReader();
      reader.onload = function (e) {
        // Get the text data
        const data = e.target.result;

        apogeeData = data.split(/\r\n|\n/);

        displayUploadSucceeded("apogeeInput");
      };

      // Read the data as binary
      reader.readAsText(file);
    });

    function getIndexBy(columnName, columns) {
      for (let i = 0; i < columns.length; i++)
        if (columns[i] == columnName)
          return i;

      // No matching name found
      return -1;
    }

    function getMarkBy(studentId) {
      for (let student of moodleData)
        if (student["Numéro d’identification"] == studentId)
          if (student["Note/20,00"] == "-")
            return "";
          else
            return student["Note/20,00"];

      // No mark found in the Moodle data file
      return "";
    }

    process.addEventListener("click", () => {
      if ((moodleData !== undefined) && (apogeeData !== undefined)) {
        // Search for data start index
        let i = 0;
        let headerIndex = -1;
        while (headerIndex == -1)
          if (apogeeData[++i].indexOf("XX_ETUDIANTS_XX") != -1)
            headerIndex = ++i;
        let columnNames = apogeeData[headerIndex].split(";");
        studentIdIndex = getIndexBy("Code_etudiant", columnNames);
        markIndex = getIndexBy("Note", columnNames);
        markingScaleIndex = getIndexBy("Bareme", columnNames);

        for (i = headerIndex + 1; i < apogeeData.length; i++) {
          let cols = apogeeData[i].split(";");
          if (cols.length > 1) {
            cols[markIndex] = getMarkBy(cols[studentIdIndex]);
            cols[markingScaleIndex] = 20;
            apogeeData[i] = cols.join(";");
          }
        }

        const blob = new Blob([apogeeData.join("\n")], { type: 'text/plain' });
        const fileURL = URL.createObjectURL(blob);

        const downloadLink = document.createElement('a');
        downloadLink.href = fileURL;
        downloadLink.download = apogeeOutputFilename;
        document.body.appendChild(downloadLink);
        downloadLink.click();

        URL.revokeObjectURL(fileURL);

        resetUploadDisplay("moodleInput");
        resetUploadDisplay("apogeeInput");
      }
    });
  </script>
</body>

</html>